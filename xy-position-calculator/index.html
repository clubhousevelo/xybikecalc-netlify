<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H1TXBTLXDW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-H1TXBTLXDW');
    </script>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">
    <!-- Immediate dark mode setup -->
    <script>
      // Set theme immediately to prevent flash
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Meta Tags -->
    <meta name="description" content="XY Bike Calc - A collection of bike geometry tools for calculating handlebar and saddle positions using X/Y coordinates. Stop guessing, set your next bike up with accurate measurements.">
    <meta name="keywords" content="bike fit, bicycle fitting, XY bike calculator, bike position calculator, bike prescription, bike geometry, bike geometry calculator, saddle position, handlebar position">
    <meta name="author" content="XY Bike Calc">
    <meta name="robots" content="index, follow">
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com https://apis.google.com https://www.googletagmanager.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://www.google-analytics.com; connect-src 'self' https://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://sheets.googleapis.com https://*.googleapis.com https://www.google-analytics.com https://analytics.google.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <title>XY Bike Calc - Bike Position Calculator</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Modal Styles -->
    <style>
        .upgrade-modal, .tos-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .upgrade-modal.show, .tos-modal.show {
            display: flex;
        }

        .upgrade-content, .tos-content {
            background-color: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .upgrade-button, .tos-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 500;
        }

        .upgrade-button:hover, .tos-button:hover {
            opacity: 0.9;
        }
        
        .tos-content h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .tos-content p {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .tos-links {
            margin-bottom: 20px;
        }
        
        .tos-links a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .tos-links a:hover {
            text-decoration: underline;
        }
        
        .tos-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .tos-decline {
            background-color: #777;
        }
    </style>
    <!-- Ensure dark mode styles are applied -->
    <style>
        /* Ensure dark mode styles are applied */
        html[data-theme="dark"] {
            --primary-color: #0A84FF;
            --secondary-color: #5E5CE6;
            --background-color: #1C1C1E;
            --card-background: #2C2C2E;
            --border-color: #3C3C3E;
            --text-color: #FFFFFF;
            --text-secondary: #98989D;
            --error-color: #FF453A;
            --success-color: #32D74B;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --bg-color: #1C1C1E;
            --nav-bg: #2C2C2E;
            --card-bg: #2C2C2E;
            --input-bg: #3C3C3E;
            --input-border: #48484A;
            --button-bg: #0A84FF;
            --button-text: #FFFFFF;
            --hover-bg: #3C3C3E;
            --table-bg: #2C2C2E;
            --table-header-bg: #3C3C3E;
            --table-hover-bg: rgba(94, 92, 230, 0.1);
        }
        
        html[data-theme="dark"] body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        html[data-theme="dark"] .calculator-container,
        html[data-theme="dark"] .bike-card,
        html[data-theme="dark"] input,
        html[data-theme="dark"] select {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
    </style>
</head>
<body class="has-client-info-card">
    <div class="tos-modal" id="tosModal">
        <div class="tos-content">
            <center><h2>Terms of Service Acknowledgment</h2></center>
            <p style="text-align: center;">
                By using XY Bike Calculator, you acknowledge and agree to our Terms of Service.
            </p>
            <p style="text-align: center;"  >
                The calculations and measurements provided are for informational purposes only and should not replace professional bike fitting services.
            </p>
            <div class="tos-links" style="text-align: center;">
                <a href="/terms-of-service/" target="_blank">Read Full Terms of Service</a>
            </div>
            <div class="tos-buttons">
                <button class="tos-button tos-decline" onclick="declineTos()">Decline</button>
                <button class="tos-button" onclick="acknowledgeTos()">Accept</button>
            </div>
        </div>
    </div>

    <button class="hamburger-menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <nav class="mobile-nav">
        <div class="nav-header">
            <a href="/"><h2>XY Bike Calc</h2></a>
        </div>
        <ul>
            <li><a href="/xy-position-calculator/" class="active">X/Y Position Calculator</a></li>
            <li><a href="/position-simulator/">Bike Position Simulator</a></li>
            <li><a href="/stack-reach-calculator/">Stack & Reach Calculator</a></li>
            <li><a href="/seatpost-calculator/">Seatpost Calculator</a></li>
            <li><a href="/stem-calculator/">Stem Calculator</a></li>
            <li><a href="/bike-search/">Bike Search</a></li>
        </ul>
        <div class="flex-spacer"></div>
        <div class="nav-item">
            <a href="/about/">About</a>
        </div>
        <div class="nav-item-guide">
            <a href="/guide/">Guide</a>
        </div>
        <div class="nav-item">
            <a href="/product-manuals/">Product Manuals</a>
        </div>
        <div class="nav-item-donate">
            <a href="/donate/">Donate</a>
        </div>
        <div class="non-auth-dependent login-container">
            <button class="login-button" onclick="window.location.href='/login/'">Login</button>
        </div>
        <div class="auth-dependent auth-container">
            <div class="user-container">
                <span class="user-display"></span>
                <button id="logout-button-mobile" class="logout-button">Logout</button>
            </div>
        </div>
        <div class="theme-toggle">
            <button id="mobileDarkModeToggle" class="dark-mode-toggle" onclick="toggleTheme()">
                <span class="toggle-icon">☀️</span>
                <span class="toggle-text">Light Mode</span>
            </button>
        </div>
        <div class="footer-links">
            <a href="/terms-of-service/" style="margin-bottom: -10px;">Terms of Service</a>
            <a href="/privacy-policy/">Privacy Policy</a>
            <div class="version">
                <a href="/changelog/">&nbsp;</a>
            </div>
        </div>
    </nav>

    <nav class="main-nav">
        <div class="nav-header">
            <a href="/"><h2>XY Bike Calc</h2></a>
        </div>
        <ul>
            <li><a href="/xy-position-calculator/" class="active">X/Y Position Calculator</a></li>
            <li><a href="/position-simulator/">Bike Position Simulator</a></li>
            <li><a href="/stack-reach-calculator/">Stack & Reach Calculator</a></li>
            <li><a href="/seatpost-calculator/">Seatpost Calculator</a></li>
            <li><a href="/stem-calculator/">Stem Calculator</a></li>
            <li><a href="/bike-search/">Bike Search</a></li>
        </ul>
        <div class="flex-spacer"></div>
        <div class="nav-item">
            <a href="/about/">About</a>
        </div>
        <div class="nav-item-guide">
            <a href="/guide/">Guide</a>
        </div>
        <div class="nav-item">
            <a href="/product-manuals/">Product Manuals</a>
        </div>
        <div class="nav-item-donate">
            <a href="/donate/">Donate</a>
        </div>
        <div class="non-auth-dependent login-container">
            <button class="login-button" onclick="window.location.href='/login/'">Login</button>
        </div>
        <div class="auth-dependent auth-container">
            <div class="user-container">
                <span class="user-display"></span>
                <button id="logout-button" class="logout-button">Logout</button>
            </div>
        </div>
        <div class="theme-toggle">
            <button id="darkModeToggle" class="dark-mode-toggle" onclick="toggleTheme()">
                <span class="toggle-icon">☀️</span>
                <span class="toggle-text">Light Mode</span>
            </button>
        </div>
        <div class="footer-links">
            <a href="/terms-of-service/" style="margin-bottom: -10px;">Terms of Service</a>
            <a href="/privacy-policy/">Privacy Policy</a>
            <div class="version">
                <a href="/changelog/">&nbsp;</a>
            </div>
        </div>
    </nav>

    <!-- Client Information Card -->
    <div class="client-info-card">
        <h2 class="client-info-title" style="text-align: center;">Rider Information</h2>
        <div class="client-info-section">
            <label for="clientName">Name:</label>
            <input type="text" id="clientName" placeholder="Rider Name">
        </div>
        <div class="client-info-section">
            <label for="clientNotes">Fit Notes:</label>
            <textarea id="clientNotes" placeholder="Notes here will populate in the 'Open' profile dialog" style="height: 62px;"></textarea>
        </div>
        
        <h3 class="client-info-section-title" style="text-align: center;">Target Position</h3>
        <div class="client-info-section">
            <div class="input-row-single">
                <label for="targetSaddleX">Saddle X:</label>
                <div class="input-with-unit">
                    <input type="number" id="targetSaddleX" placeholder="">
                    <span>mm</span>
                </div>
            </div>

            <div class="input-row-single">
                <label for="targetSaddleY">Saddle Y:</label>
                <div class="input-with-unit">
                    <input type="number" id="targetSaddleY" placeholder="">
                    <span>mm</span>
                </div>
            </div>

            <div class="input-row-single" style="margin-top: 15px;">
                <label for="targetHandlebarX">Handlebar X:</label>
                <div class="input-with-unit">
                    <input type="number" id="targetHandlebarX" placeholder="">
                    <span>mm</span>
                </div>
            </div>

            <div class="input-row-single">
                <label for="targetHandlebarY">Handlebar Y:</label>
                <div class="input-with-unit">
                    <input type="number" id="targetHandlebarY" placeholder="">
                    <span>mm</span>
                </div>
            </div>
            
            <div class="input-row-single">
                <label for="handlebarReachUsed">Bar Reach Used:</label>
                <div class="input-with-unit">
                    <input type="number" id="handlebarReachUsed" placeholder="">
                    <span>mm</span>
                </div>
            </div>
        </div>

        <label class="tooltip-client-info"><h3 class="client-info-section-title" style="text-align: center;">Component Notes<span class="tooltip-text">Notes about the components that were used to plan to be used. These notes have no bearing on the calculations.</span></h3></label>
        <div class="client-info-section">
            <label for="saddleNotes">Saddle:</label>
            <textarea id="saddleNotes" placeholder=""></textarea>
        </div>
        <div class="client-info-section">
            <label for="handlebarNotes">Handlebar:</label>
            <textarea id="handlebarNotes" placeholder=""></textarea>
        </div>
        <div class="client-info-section">
            <label for="crankLengthNotes">Crank Length:</label>
            <textarea id="crankLengthNotes" placeholder=""></textarea>
        </div>
        <div class="client-info-section">
            <label for="drivetrainNotes">Drivetrain:</label>
            <textarea id="drivetrainNotes" placeholder=""></textarea>
        </div>
        <div class="client-buttons">
            <button id="saveButton" disabled>Save</button>
            <button id="loadButton">Open</button>
        </div>

    </div>
    
    <!-- Client Info Toggle Button -->
    <button class="client-info-toggle" id="clientInfoToggle"><div style="margin-left:-2px;">◁</div></button>
    
    <div class="calculator-container" id="calculatorContainer">
        <div class="calculator-header">
            <h1 class="calculator-title">
                <span class="collapse-indicator">▼</span>
                X/Y Position Calculator
            </h1>
            <p class="calculator-description">This tool is designed to help you prescribe and compare bikes by calculating the X/Y coordinate positions of the handlebar and saddle. <br>Highlighted stem configuration fields indicate stock or max (spacers) values pulled from manufacturer product manuals or from personal experience.</p>
        </div>

        <div class="bikes-container-wrapper">
            <div id="bikes-container"></div>
        </div>

        <div class="add-buttons">
            <button id="addBike">Add Bike</button>
            <button id="addManualBike">Add Manual Bike</button>
            <button id="printButton" class="print-button">Print</button>
            <button id="clearAllData" class="clear-button">Reset All</button>
        </div>
        <!-- XY Stem Comparison Visual -->
        <div class="xy-stem-visualization-section">
            <h3 class="xy-stem-visualization-title">Handlebar X/Y Visual Comparison</h3>
            <canvas id="xyStemVisualizationCanvas" width="550" height="400" style="width:100%;max-width:550px;display:block;margin:0 auto 10px auto;background:var(--card-bg);"></canvas>
            <div class="xy-stem-legend" style="display:flex;justify-content:left;gap:10px;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Custom Scripts -->
    <script src="../js/api-client.js"></script>
    <script src="../js/debounce-utils.js"></script>
    <script>window.USE_BACKEND_CALC = true;</script>
    <script src="../js/version.js"></script>
    <script src="../js/mobile-menu.js"></script>
    <script src="../js/calculator-header.js"></script>
    <script src="../js/firebase-auth.js"></script>
    <script src="../js/calculator.js"></script>
    <script>
        // Initialize the calculator
        window.calculator = new BikeCalculator();
        
        // Global function for dark mode toggle
        function toggleTheme() {
            // Toggle theme
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Apply theme
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update all toggle buttons
            document.querySelectorAll('#darkModeToggle, #mobileDarkModeToggle').forEach(btn => {
                const icon = btn.querySelector('.toggle-icon');
                const text = btn.querySelector('.toggle-text');
                
                if (icon) icon.textContent = newTheme === 'dark' ? '🌙' : '☀️';
                if (text) text.textContent = newTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
            });
            
            return false; // Prevent default action
        }
        
        // Update button appearance on page load
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        document.querySelectorAll('#darkModeToggle, #mobileDarkModeToggle').forEach(btn => {
            const icon = btn.querySelector('.toggle-icon');
            const text = btn.querySelector('.toggle-text');
            
            if (icon) icon.textContent = currentTheme === 'dark' ? '🌙' : '☀️';
            if (text) text.textContent = currentTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
        });
    </script>
    
    <!-- Client Information Card Sync Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Client info card elements are the same as the calculator elements now
            const clientName = document.getElementById('clientName');
            const targetSaddleX = document.getElementById('targetSaddleX');
            const targetSaddleY = document.getElementById('targetSaddleY');
            const targetHandlebarX = document.getElementById('targetHandlebarX');
            const targetHandlebarY = document.getElementById('targetHandlebarY');
            const handlebarReachUsed = document.getElementById('handlebarReachUsed');
            const clientNotes = document.getElementById('clientNotes');
            const saddleNotes = document.getElementById('saddleNotes');
            const handlebarNotes = document.getElementById('handlebarNotes');
            const crankLengthNotes = document.getElementById('crankLengthNotes');
            const drivetrainNotes = document.getElementById('drivetrainNotes');
            
            // Client Info Toggle Button
            const clientInfoToggle = document.getElementById('clientInfoToggle');
            const clientInfoCard = document.querySelector('.client-info-card');
            const calculatorContainerWrapper = document.getElementById('calculatorContainer');
            // Toggle client info card when button is clicked
            clientInfoToggle.addEventListener('click', function() {
                clientInfoCard.classList.toggle('active');
                clientInfoToggle.classList.toggle('active');
                calculatorContainerWrapper.classList.toggle('active');
            });

            clientInfoToggleExpand.addEventListener('click', function() {
                clientInfoCard.classList.toggle('active');
                clientInfoToggle.classList.toggle('active');
                calculatorContainerWrapper.classList.toggle('active');
            });
            
            // Enable save button if client name is filled
            clientName.addEventListener('input', function() {
                document.getElementById('saveButton').disabled = !clientName.value.trim();
            });
            
            // Trigger calculation events when input changes
            [targetSaddleX, targetSaddleY, targetHandlebarX, targetHandlebarY, handlebarReachUsed].forEach(el => {
                el.addEventListener('input', function() {
                    if (this.value) {
                        const event = new Event('input', { bubbles: true });
                        this.dispatchEvent(event);
                    }
                });
            });
            
            // Initialize when client is loaded
            document.getElementById('loadButton').addEventListener('click', function() {
                // Wait a bit for the client data to load
                setTimeout(function() {
                    // Check if client name is filled to enable save button
                    document.getElementById('saveButton').disabled = !clientName.value.trim();
                }, 300);
            });
        });
    </script>

    <script>
        // Terms of Service acknowledgment handling
        function acknowledgeTos() {
            localStorage.setItem('tosAcknowledged', 'true');
            document.getElementById('tosModal').classList.remove('show');

        }
        
        function declineTos() {
            // Redirect to a neutral page or display a message
            window.location.href = '../about/';
        }

        // Show popups in correct order
        document.addEventListener('DOMContentLoaded', function() {
            // First check if ToS needs to be shown
            if (!localStorage.getItem('tosAcknowledged')) {
                document.getElementById('tosModal').classList.add('show');
            } 
        });
    </script>
</body>
</html>
